#!/bin/bash
# bash filename


# check if image include vulnerabilites
trivy_scanning_vulnerabilities(){
    ImageList=("$1" "$2" "$3")
    for image in ${ImageList[*]};
    do
        ifImageExist=$(trivy image $image | grep HIGH)
        if [ -z "$ifImageExist" ];then
            echo "$image isn't include HIGH vulnerabilities"
            total=$(trivy image $image | grep Total)
            LOW=$(echo $total | awk '{print $6}' | sed 's/)//g;s/,//g')
            MEDUIM=$(echo $total | awk '{print $8}' | sed 's/)//g;s/,//g')
            HIGH=$(echo $total | awk '{print $10}' | sed 's/)//g;s/,//g')
            CRITICAL=$(echo $total | awk '{print $12}' | sed 's/)//g;s/,//g')
            echo "LOW:$LOW"
            echo "MEDUIM:$MEDUIM"
            echo "HIGH:$HIGH"
            echo "CRITICAL:$CRITICAL"
            #exit 0
        else
            echo "$image include HIGH vulnerabilities, remove it"
            total=$(trivy image $image | grep Total)
            LOW=$(echo $total | awk '{print $6}' | sed 's/)//g;s/,//g')
            MEDUIM=$(echo $total | awk '{print $8}' | sed 's/)//g;s/,//g')
            HIGH=$(echo $total | awk '{print $10}' | sed 's/)//g;s/,//g')
            CRITICAL=$(echo $total | awk '{print $12}' | sed 's/)//g;s/,//g')
            echo "LOW:$LOW"
            echo "MEDUIM:$MEDUIM"
            echo "HIGH:$HIGH"
            echo "CRITICAL:$CRITICAL"
            ifContainerExist=$(docker ps | grep $image)
            if [ -z "$ifContainerExist" ];then
                sudo docker image rm $image
		echo "$image has removed"
            else
                echo "$image is in used"
               # exit 0
            fi
        fi
    done
}

trivy_scanning_vulnerabilities python node alpine