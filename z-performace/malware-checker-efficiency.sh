#!/bin/bash
# bash filename

# ClamAV Scanning efficiency
clamAV_scaning(){
    ImageList=("$1" "$2" "$3")
    for image in ${ImageList[*]};
    do
    ContainerID=$(sudo docker ps | grep $image | awk '{print $1}')
    
    # get CPU & memory usage
    cpuUsageBefore=$(top -bn1 | awk '/Cpu/ { print $2}')
    memUsageBefore=$(free -m | awk '/Mem/{print $3}')
        for id in $ContainerID;
        do
            DirPath=$(sudo docker inspect $id | grep MergedDir | awk -F '"' '{print $4}')
            ScanTime=$(sudo clamscan --recursive --infected $DirPath | grep Time | awk '{print $2}')
            ClamAVImageScanTimeMap[$image]=$ScanTime
            cpuUsageAfter=$(top -bn1 | awk '/Cpu/ { print $2}')
            memUsageAfter=$(free -m | awk '/Mem/{print $3}')
        done

    echo "CPU Usage before execution is $cpuUsageBefore %"
    echo "CPU Usage after execution is $cpuUsageAfter %"
    echo "Memory Usage before execution is $memUsageBefore MB"
    echo "Memory Usage after execution is $memUsageAfter MB"

    echo "Total Image $image scanning time is:$ScanTime seconds"
    done
}

# call function
clamAV_scaning python node alpine