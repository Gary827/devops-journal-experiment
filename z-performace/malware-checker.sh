#!/bin/bash
# bash filename

clamav_scanning_vulnerabilities(){
    ImageList=("$1" "$2" "$3")
    for image in ${ImageList[*]};
    do
        ContainerID=$(sudo docker ps | grep $image | awk '{print $1}')
        if [ -z "$ContainerID" ];then
            echo "$image does not have container"
        else
            DirPath=$(sudo docker inspect $ContainerID | grep MergedDir | awk -F '"' '{print $4}')
            InfectedFiles=$(sudo clamscan --recursive --infected $DirPath | grep "Infected files" | awk -F ': ' '{print $2}' | bc -l)
            if (($InfectedFiles > 0));then
                echo "$image include Malware, remove it"
                ifContainerExist=$(docker ps | grep $image)
                if [ -z '$ifContainerExist' ];then
                    sudo docker image rm $image
		    echo "$image has removed"
                else
                echo "$image is in used"
                fi
            else
                echo $image is ok
            fi
            echo "Number of Infected Files:$InfectedFiles"
        fi
    done
}

clamav_scanning_vulnerabilities python:latest node:latest alpine:latest